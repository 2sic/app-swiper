@inherits Custom.Hybrid.Razor12
@using Newtonsoft.Json;
@using ToSic.Razor.Blade;
@{
  // Get some helper commands for later on
  var helpers = CreateInstance("Helpers.cs");

  // Merge the settings on Content with the predefined Settings
  var swiper = Content; // Give it a better name, to make the code more readable
  var swiperSettings = AsDynamic(swiper, Settings);

  // Figure out width and height
  var sliderWidth = swiperSettings.Width;
  var sliderHeightOrRatio = swiperSettings.Height; // contains height like "100vh" or a ratio like "x:y"

  // Prepare style to set height or aspect ratio (determined by the ":" in the height)
  var isRatio = sliderHeightOrRatio.IndexOf(":") > 0;
  var aspectRatioStyle = isRatio ? "--aspect-ratio:calc(" + sliderHeightOrRatio.Replace(":", "/")  + ")": "";
  var swiperContainerHeight = isRatio ? "" : "height: " + sliderHeightOrRatio + ";";
}

@* TODO: 2RO - five! DIVs which are just in each-other. Do we really need app-swiper2/aspect-ratio/inner/swiper-container/swiper-wrapper in separate DIVs? if yes, pls doc, or change *@
<div class="app-swiper2" @Edit.TagToolbar(swiper, toolbar: new [] { "settings&hover=left&autoAddMore=start" })>
  <div style="@aspectRatioStyle">
    <div class="inner">
      @* Slider main container and wrapper *@
      <div class="swiper-container swiper-@swiper.EntityId" style="width: @sliderWidth; @swiperContainerHeight">
        <div class="swiper-wrapper">

          @* if we don't have slides, show a dummy slide and provide buttons to start adding *@
          @if(swiper.Slides.Count == 0) {
            @Html.Partial("./_Swiper.PartEmpty.cshtml")
          }

          @* Slides - Add each one (if there are any) *@
          @foreach (var slide in swiper.Slides) {
            // Merge settings of the current slide, the swiper defaults and the App settings/defaults
            var sldSettings = AsDynamic(slide, swiper, Settings);
            var overlayEffect = sldSettings.OverlayEffect;    // Positioning
            var duration = sldSettings.ShowDuration;          // time the slide will show if auto-playing

            <div class="swiper-slide" data-swiper-autoplay="@duration" @(swiper.IsDemoItem ? "" : Edit.TagToolbar(slide, toolbar: new[] { "%delete&show=true" } ))>
              <div class="image-wrapper @helpers.WrapperClasses(sldSettings)">
                @* Add the <picture> tag with all the sources *@
                @helpers.PictureTag(slide.Image.ToLower(), slide.Title)

                @* TODO: 2RO - WHY IS THIS div separate from everything? if it's correct, pls explain here *@
                @if (Text.Has(slide.Title) || Text.Has(slide.Text) || Text.Has(slide.LinkText)) {
                  <div class="overlay overlay-@overlayEffect"></div>
                }
                @* TODO: 2RO - SHOULD THE IF(...) above not also wrap this? and only add these things if there is anything to add? *@
                @* TODO: 2RO - there are a lot of DIVs in DIVs - do we really need that stack? if yes, pls doc or fix *@
                <div class="container-fluid h-100">
                  <div class="@helpers.RowClasses(sldSettings)">
                    <div class="col-12 py-4">
                      <div class="@helpers.ContentClasses(sldSettings)">
                        @* Show Title in overlay *@  
                        @if (Text.Has(slide.Title)) {
                          <p class="lead" data-swiper-parallax="-250">@slide.Title</p>
                        }
                        @* Show Description / additional Text in overlay *@  
                        @if (Text.Has(slide.Text)) {
                          <div class="co-slidertext" data-swiper-parallax="-500">@Html.Raw(slide.Text)</div>
                        }
                        @* Show Link in overlay *@  
                        @if (Text.Has(slide.LinkText)) {
                          <div data-swiper-parallax="-750">
                            <a class="btn btn-primary" href="@Link.Image(slide.Link)" target='@(slide.LinkBlankTarget == true ? "_blank" : "")'>@slide.LinkText</a>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          }

        </div>

        @* Pagination *@
        @if (swiperSettings.ShowPaginationDots) {
          <div class="swiper-pagination"></div>
        }

        @* Navigation buttons (right left arrows) *@
        @if (swiperSettings.ShowPaginationArrows) {
          <div class="swiper-button-prev"></div>
          <div class="swiper-button-next"></div>
        }
      </div>
    </div>
  </div>
</div>

@Html.Partial("./_Swiper.PartAssets.cshtml", new { SwiperSettings = swiperSettings })